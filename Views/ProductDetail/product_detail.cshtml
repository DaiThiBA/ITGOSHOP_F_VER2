@using System.Globalization;
@{
    ViewData["Title"] = "Tên sản phẩm";
    Layout = "~/Views/Shared/_ClientLayout.cshtml";
    CultureInfo cul = CultureInfo.GetCultureInfo("vi-VN");
}

<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="bread-inner">
                    <ul class="bread-list">
                        <li><a href="index.html">Trang chủ<i class="ti-arrow-right"></i></a></li>
                        <li class="active"><a href="#">@ViewBag.ProductDetail.GetType().GetProperty("CategoryName").GetValue(ViewBag.ProductDetail, null) </a></li>
                        <li class="active"><i class="ti-arrow-right"></i></li>
                        <li class="active"><a href="#">@ViewBag.ProductDetail.GetType().GetProperty("BrandName").GetValue(ViewBag.ProductDetail, null) </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Breadcrumbs -->
<!-- Start Blog Single -->
<section class="blog-single section">
    <div class="container">
        <div class="row">
            <div class="ps-product--detail ">
                <div class="ps-container">
                    <div class="row">
                        <div class="col-lg-12 col-12">
                            <div class="ps-product__thumbnail" style="height: 350px; width: 500px;">
                                <div class="ps-product__preview">
                                    <div class="ps-product__variants">
                                        <div class="item"><img src="~/public/images_upload/product/@ViewBag.ProductDetail.GetType().GetProperty("ProductImage").GetValue(ViewBag.ProductDetail, null)" alt=""></div>
                                        @foreach (var image in @ViewBag.ProductGallary)
                                        {
                                            <div class="item"><img src="~/public/images_upload/product-gallary/@image.GallaryImage" alt=""></div>
                                        }
                                    </div>
                                </div>
                                <div class="ps-product__image" style="max-height: 350px; max-width: 350px; width: auto; height: auto;">
                                    <div class="item"><img class="zoom" src="~/public/images_upload/product/@ViewBag.ProductDetail.GetType().GetProperty("ProductImage").GetValue(ViewBag.ProductDetail, null)" alt="" data-zoom-image="~/public/images_upload/product/@ViewBag.ProductDetail.GetType().GetProperty("ProductImage").GetValue(ViewBag.ProductDetail, null)"></div>
                                    @foreach (var image in @ViewBag.ProductGallary)
                                    {
                                        <div class="item"><img class="zoom" src="~/public/images_upload/product-gallary/@image.GallaryImage" alt=""></div>
                                    }
                                </div>
                            </div>
                            <div class="ps-product__thumbnail--mobile">
                                <div class="ps-product__main-img"><img src="~/public/images_upload/product/@ViewBag.ProductDetail.GetType().GetProperty("ProductImage").GetValue(ViewBag.ProductDetail, null)" alt=""></div>
                                <div class="ps-product__preview owl-slider" data-owl-auto="true" data-owl-loop="true" data-owl-speed="5000" data-owl-gap="20" data-owl-nav="true" data-owl-dots="false" data-owl-item="3" data-owl-item-xs="3" data-owl-item-sm="3" data-owl-item-md="3" data-owl-item-lg="3" data-owl-duration="1000" data-owl-mousedrag="on">
                                    @foreach (var image in @ViewBag.ProductGallary)
                                    {
                                        <img src="~/public/images_upload/product-gallary/@image.GallaryImage" alt="">
                                    }
                                </div>
                            </div>
                            <div class="ps-product__info" style="padding-left: 0px;">
                                <form action="/ProductDetail/save_cart" method="POST" style="max-width:620px;">
                                    <h2 class="blog-title">@ViewBag.ProductDetail.GetType().GetProperty("ProductName").GetValue(ViewBag.ProductDetail, null)</h2>
                                    <div class="blog-meta" style="padding-top:30px">
                                        <span class="author">
                                            <!--if(product->Rating == 0)
                                            <a><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i>Chưa có đánh giá</a>
                                        else
                                            <a>
                                            i = 0;
                                            for(i; i < product->Rating; $i++)
                                                <i class="fa fa-star-o"></i>
                                            endfor
                                            product->Rating</a>
                                        endif-->
                                            <a><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i><i class="fa fa-star-o"></i>Chưa có đánh giá</a>
                                            <a><i class="fa fa-shopping-cart"></i>Đã bán @ViewBag.ProductDetail.GetType().GetProperty("Sold").GetValue(ViewBag.ProductDetail, null)</a>
                                            @if (ViewBag.ProductDetail.GetType().GetProperty("Quantity").GetValue(ViewBag.ProductDetail, null) < 10)
                                            {
                                                <a><i class="fa fa-archive"></i>Chỉ còn lại @ViewBag.ProductDetail.GetType().GetProperty("Quantity").GetValue(ViewBag.ProductDetail, null) sản phẩm</a>
                                            }
                                            else
                                            {
                                                <a><i class="fa fa-archive"></i>Còn @ViewBag.ProductDetail.GetType().GetProperty("Quantity").GetValue(ViewBag.ProductDetail, null) sản phẩm</a>
                                            }
                                        </span>
                                    </div>
                                    <div class="content">
                                        <div class="blog-meta">
                                            <h1 style="color:red; background-color:#FAFAFA;padding: 25px;font-weight: bold; ">
                                                <!-- Gía sản phẩm -->
                                                @ViewBag.ProductDetail.GetType().GetProperty("Price").GetValue(ViewBag.ProductDetail, null).ToString("#,###", cul.NumberFormat) ₫
                                                <sub style="color:black; font-size:15px ">
                                                    <!--  Phần giảm giá -->
                                                    <del>@((@ViewBag.ProductDetail.GetType().GetProperty("Price").GetValue(ViewBag.ProductDetail, null) + @ViewBag.ProductDetail.GetType().GetProperty("Price").GetValue(ViewBag.ProductDetail, null) * ((@ViewBag.ProductDetail.GetType().GetProperty("Discount").GetValue(ViewBag.ProductDetail, null))/100)).ToString("#,###", cul.NumberFormat)) ₫</del>
                                                    <span class="o-giam-gia">- @ViewBag.ProductDetail.GetType().GetProperty("Discount").GetValue(ViewBag.ProductDetail, null)% </span>
                                                </sub>
                                            </h1>
                                        </div>
                                        <div class="single-widget get-button">
                                            <div class="content">
                                                <p>Số lượng: <input name="quantity" type="number" min="1" value="1" size="4" style="width:50px"></p>
                                                <div class="button">
                                                    <button type="submit" class="btn">
                                                        Thêm vào giỏ hàng
                                                    </button>
                                                </div>
                                                <input name="productId" type="hidden" class="input_product_id" value="@ViewBag.ProductDetail.GetType().GetProperty("ProductId").GetValue(ViewBag.ProductDetail, null)">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-lg-12 col-12">
                <div class="main-sidebar">
                    <!-- Single Widget -->
                        <div class="blog-detail">
                            <h2 class="blog-title">Chi Tiết Sản Phẩm</h2>
                            <div class="content">
                                <!-- Nội dung sản phẩm -->
                                <div class="blog-meta">
                                    <p>@Html.Raw(@ViewBag.ProductDetail.GetType().GetProperty("Content").GetValue(ViewBag.ProductDetail, null))</p> <!-- Thêm Html.Raw để dataa ko bị lỗi nếu data đã được styling-->
                                </div>
                                <!-- End Nội dung sản phẩm -->

                            </div>
                        </div>
                        <div class="share-social">
                            <div class="row">
                                <div class="col-12">
                                    <div class="content-tags">
                                        <h4>Tags:</h4>
                                        <ul class="tag-inner">
                                            <li><a href="#">Glass</a></li>
                                            <li><a href="#">Pant</a></li>
                                            <li><a href="#">t-shirt</a></li>
                                            <li><a href="#">swater</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="comments">
                <h3 class="comment-title">
                    <a style="font-weight: bold;">Đánh giá sản phẩm</a>
                    <div class="ps-product__rating">
                        <select class="ps-rating">
                            <option value="1">1</option>
                            <option value="1">2</option>
                            <option value="1">3</option>
                            <option value="1">4</option>
                            <option value="2">5</option>
                        </select>
                    </div>
                </h3>
                <h3 class="comment-title">
                    <a style="font-weight: bold;">Bình luận</a>
                </h3>
                <h4>Bình luận của bạn</h4>
                <div class="o-binh-luan" style="margin:0px 0px 30px;">
                    <!-- <button type="button" style="position: absolute;right: 60px; bottom:550px;width: 60px;height: 30px; width: 60px;height: 30px;border-radius: 50px;font-size: 14px;background: black;"> <a href="#" style="color: white;font-weight: bold;">Gửi</a> </button> -->
                    <textarea class="textarea-commnent-content" name="CommentContent" rows="4" style="padding: 16px; border-radius: 8px; resize: none; margin: 10px 0px 10px; font-size: 16px; background-color:#F3F5F8;" placeholder="Mời bạn để lại bình luận"></textarea>
                    <button class="send-comment-button" type="button" style="margin-bottom:30px;float:right;width: 60px;height: 30px; width: 60px;height: 30px;border-radius: 50px;font-size: 14px;background: black;"> <a href="javascript:void(0)" style="color: white;font-weight: bold;">Gửi</a> </button>
                </div>


                <!-- </div> -->

                <form>
                    <input name="ProductId" type="hidden" class="input_product_id" value="@ViewBag.ProductDetail.GetType().GetProperty("ProductId").GetValue(ViewBag.ProductDetail, null)">
                    <div id="show_comment"></div>
                </form>
            </div>
        </div>
        @if (@ViewBag.RelatedProduct.Count != 0)
        {
            <div class="product-area most-popular section">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="section-title">
                                <h2>Các sản phẩm liên quan</h2>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="owl-carousel popular-slider">
                                @foreach (var item in @ViewBag.RelatedProduct)
                                 { 
                                <!-- Start Single Product -->
                                <div class="single-product">
                                    <div class="product-img" style="width: 250px; height: 200px;">
                                        <a href="/ProductDetail/Index?productId=@item.ProductId">
                                            <img class="default-img" style="margin: auto; max-width: 250px; max-height: 200px; width: auto; height: auto; " src="~/public/images_upload/product/@item.ProductImage" alt="#">
                                            <img class="hover-img" src="~/public/images_upload/product/@item.ProductImage" alt="">

                                        </a>
                                        <div class="button-head">
                                            <div class="product-action">
                                                <a data-toggle="modal" data-target="#exampleModal" title="Quick View" href="#"><i class=" ti-eye"></i><span>Lượt xem: @item.View</span></a>
                                                <a title="Wishlist" href="#"><i class=" ti-heart "></i><span>Yêu thích</span></a>
                                            </div>
                                            <div class="product-action-2">
                                                <a title="Add to cart" class="add-to-cart-a-tag" href="javascript:void(0)">Thêm vào giỏ hàng</a>
                                                <input type="text" value="@item.ProductId" hidden>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="product-content">
                                        <h3><a href="/ProductDetail/product_detail?productId=@item.ProductId">@item.ProductName</a></h3>
                                        <div class="product-price">
                                            <span>@item.Price.ToString("#,###", cul.NumberFormat) ₫</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- End Single Product -->
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>
<!--/ End Blog Single -->



<script>
		$(document).ready(function(){
			var product_id = $('.input_product_id').val();
			var _token = $('input[name="_token"]').val();
			load_comment();
			setInterval(load_comment, 20000);
			function load_comment()
			{
				$.ajax({
					url: "{{url('/load-comment')}}",
					method:"POST",
					data:{ProductId: product_id, _token:_token},
					success:function(data){
						$('#show_comment').html(data);
					},
					error:function(data)
					{
						alert("Lỗi");
					}
				});
			}
			$('.send-comment-button').click(function(){
				var customer_id = $('#input-customer-id').val();
				var admin_id = $('#input-admin-id').val();
				if(customer_id || admin_id)
				{
					var ProductId = $('.input_product_id').val();
					var CommentContent = $('.textarea-commnent-content').val();
					var _token = $('input[name="_token"]').val();
					if(CommentContent != '')
					{
						$.ajax({
							url:"{{url('/send-comment')}}",
							method: "POST",
							data:{ProductId: ProductId, CommentContent: CommentContent, _token:_token, ParentComment:0},
							success:function(data){
								load_comment();
								$('.textarea-commnent-content').val('');
							},
							error:function(data)
							{
								alert("Lỗi");
							}
						});
					}
					else
					{
						swal("Vui lòng nhập nội dung bình luận.");
					}
				}
				else
				{
					swal({
						text: "Bạn cần đăng nhập để thêm bình luận cho sản phẩm.",
						icon: "info",
						buttons: ["OK", "Đăng nhập"],
						}).then(function(isConfirm) {
							if (isConfirm) {
								window.location = "{{url('/login')}}";
							}
					})
				}
			});

			$('body').on('click', '.send-sub-comment-button' ,function(){
				var customer_id = $('#input-customer-id').val();
				var admin_id = $('#input-admin-id').val();
				if(customer_id || admin_id)
				{
					var ProductId = $('.input_product_id').val();
					var CommentContent = $('.textarea-sub-commnent-content').val();
					var ParentComment = $(this).parents('.o-comment').find('.ParentCommentId').val();
					var _token = $('input[name="_token"]').val();
					var add_next_cmt = $(this).parents('.o-comment').find('.single-comment').last();
					if(CommentContent != '')
					{
						$.ajax({
							url:"{{url('/send-comment')}}",
							method: "POST",
							data:{ProductId: ProductId, CommentContent: CommentContent, _token:_token, ParentComment: ParentComment},
							success:function(data){
								load_comment();
								$('.textarea-commnent-content').val('');
								add_next_cmt.css('background','#ccf2f4');
								$('html, body').animate({scrollTop: add_next_cmt.offset().top}, 700);
							},
							error:function(data)
							{
								alert("Lỗi");
							}
						});
					}
					else
					{
						swal("Vui lòng nhập nội dung bình luận.");
					}
				}
				else
				{
					swal({
						text: "Bạn cần đăng nhập để thêm bình luận cho sản phẩm.",
						icon: "info",
						buttons: ["OK", "Đăng nhập"],
						}).then(function(isConfirm) {
							if (isConfirm) {
								window.location = "{{url('/login')}}";
							}
					})
				}
			});

			$('body').on('click', '.btn-xoa-comment' ,function(){
				var comment_id = $(this).parents('.single-comment').find('.CommentId').val();
				var thisdiv = $(this).parents('.single-comment');
				$.ajax({
					url:"{{url('/delete-comment')}}",
					method: "GET",
					data:{comment_id: comment_id},
					success:function(data){
						swal({
								title: "Xác nhận",
								text: "Bạn có chắc muốn xóa bình luận này không?",
								icon: "warning",
								buttons: true,
								dangerMode: true,
								})
								.then((willDelete) => {
								if (willDelete) {
									load_comment();
								}
							});
					},
					error:function(data)
					{
						alert("Lỗi");
					}
				});
			});

			$('body').on('click', '.btn-reply', function(){
				var o_binh_luan_khac = $(this).parents('.comments').find('.o-binh-luan-con').remove();
				var noidung = '';
				noidung += "<form> <input type='hidden' name='_token' value='{{ csrf_token() }}' /><div class='o-binh-luan-con' style='margin:0px 0px 30px;'><textarea class='textarea-sub-commnent-content' name='CommentContent' rows='2' style='padding: 16px; border-radius: 8px; resize: none; margin: 10px 0px 10px; font-size: 16px; background-color:#F3F5F8;' placeholder='Mời bạn để lại bình luận'></textarea>";
				noidung += "<button class='send-sub-comment-button' type='button'style='margin-bottom:30px;float:right;width: 60px;height: 30px; width: 60px;height: 30px;border-radius: 50px;font-size: 14px;background: black;'>  <a href='javascript:void(0)' style='color: white;font-weight: bold;'>Gửi</a> </button></div></form>";
				$(this).parents('.single-comment').append(noidung);
			});
		});
</script>